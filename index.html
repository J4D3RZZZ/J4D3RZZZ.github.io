<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Classroom Allocation System</title>
  <style>
    :root {
      --bg: #0f1724;
      --card: #0b1220;
      --muted: #98a0b3;
      --accent: #47c6ff;
      --ok: #2ee6a7;
      --bad: #ff6b6b;
      --warning: #fbbf24;
      --reserved: #a78bfa;
    }
    * { box-sizing: border-box; font-family: Inter, system-ui, Segoe UI, Roboto, Arial; }
    body {
      margin: 0;
      background: #071028;
      color: #e6eef8;
      min-height: 100vh;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 32px;
    }
    .container { width: 100%; max-width: 1200px; }
    .card {
      background: rgba(255, 255, 255, 0.02);
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 6px 30px rgba(5, 10, 20, .6);
      margin-bottom: 16px;
    }
    .rooms-list { display: grid; gap: 10px; }
    .room {
      padding: 12px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.05);
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .room:hover { background: rgba(255, 255, 255, 0.04); }
    .room.selected { 
      background: rgba(71, 198, 255, 0.1);
      border-color: var(--accent);
    }
    .chip {
      padding: 6px 8px;
      border-radius: 8px;
      font-weight: 700;
      background: rgba(255, 255, 255, 0.05);
      display: inline-block;
    }
    .status {
      font-size: 13px;
      padding: 6px 8px;
      border-radius: 8px;
      color: #022;
      display: inline-block;
    }
    .status.available { background: var(--ok); }
    .status.occupied { background: var(--bad); }
    .status.reserved { background: var(--reserved); }
    .grid { display: grid; grid-template-columns: 1fr 400px; gap: 16px; }
    .clock { font-size: 14px; color: var(--accent); font-weight: 600; margin-top: 4px; }
    .header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 8px;
    }
    footer { margin-top: 18px; color: var(--muted); font-size: 13px; }
    input, select {
        width: 100%;
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #334155;
        background: #1e293b;
        color: #e6eef8;
        margin-bottom: 12px;
        font-family: inherit;
    }
    input:focus, select:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(71, 198, 255, 0.2);
    }
    button {
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        background: var(--accent);
        color: #071028;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s ease;
        font-family: inherit;
    }
    button:hover { background: #3bb5e8; }
    button:disabled { 
        background: #334155; 
        color: var(--muted); 
        cursor: not-allowed; 
    }
    .btn-secondary {
        background: #334155;
        color: #e6eef8;
    }
    .btn-secondary:hover { background: #475569; }
    .btn-danger {
        background: var(--bad);
        color: white;
    }
    .btn-danger:hover { background: #ff5252; }
    .btn-small {
        padding: 4px 8px;
        font-size: 12px;
    }

    /* Reservations List */
    .reservations {
      margin-top: 8px;
      font-size: 12px;
    }
    .reservation-item {
      background: rgba(167, 139, 250, 0.1);
      padding: 4px 8px;
      border-radius: 4px;
      margin: 2px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .current-booking {
      background: rgba(255, 107, 107, 0.2);
      border-left: 3px solid var(--bad);
      padding-left: 8px;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: var(--card);
      padding: 24px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal h3 { margin-top: 0; color: var(--accent); }
    .time-input-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .error {
      color: var(--bad);
      font-size: 12px;
      margin-top: -8px;
      margin-bottom: 12px;
    }
    .success {
      color: var(--ok);
      font-size: 12px;
      margin-top: -8px;
      margin-bottom: 12px;
    }
    .warning {
      color: var(--warning);
      font-size: 12px;
      margin-top: -8px;
      margin-bottom: 12px;
    }
    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 16px;
    }
    .login-toggle {
      background: var(--accent);
      color: #071028;
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
    }

    /* Login Form */
    .login-form {
      display: none;
      background: rgba(255, 255, 255, 0.02);
      padding: 16px;
      border-radius: 8px;
      margin-top: 12px;
      max-width: 400px;
    }
    .login-form.show { display: block; }

    .schedule-view {
      background: rgba(255, 255, 255, 0.02);
      padding: 12px;
      border-radius: 8px;
      margin-top: 8px;
    }
    .time-slot {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 13px;
    }
    .time-slot:last-child { border-bottom: none; }
    .slot-time { color: var(--muted); }
    .slot-status { 
      padding: 2px 6px; 
      border-radius: 4px; 
      font-size: 11px; 
      font-weight: 600;
    }
    .slot-free { background: rgba(46, 230, 167, 0.2); color: var(--ok); }
    .slot-occupied { background: rgba(255, 107, 107, 0.2); color: var(--bad); }
    .slot-reserved { background: rgba(167, 139, 250, 0.2); color: var(--reserved); }

    @media (max-width: 768px) {
      .grid { grid-template-columns: 1fr; }
      .container { padding: 16px; }
      body { padding: 16px; }
      .header-actions { flex-wrap: wrap; }
    }
  </style>
</head>
<body>

<div class="container">
  <header style="margin-bottom:20px">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 12px;">
      <div>
        <div style="font-size:22px;font-weight:700">Smart Classroom Allocation System</div>
        <div class="clock" id="clock"></div>
      </div>
      <div class="header-actions">
        <span id="userStatus" style="font-size: 13px; color: var(--muted);">Guest Mode</span>
        <button id="loginToggle" class="btn-secondary">Login</button>
        <button id="logoutBtn" style="display: none;" class="btn-danger btn-small">Logout</button>
      </div>
    </div>
    
    <!-- Login Form -->
    <div id="loginForm" class="login-form">
      <h4 style="margin-top: 0;">Login to Reserve Rooms</h4>
      <input id="username" placeholder="Username (e.g., admin)">
      <input id="password" type="password" placeholder="Password (e.g., 1234)">
      <div style="display: flex; gap: 10px;">
        <button id="loginBtn">Login</button>
        <button id="cancelLogin" class="btn-secondary">Cancel</button>
      </div>
      <div id="loginMsg" style="margin-top:10px;color:var(--muted)"></div>
      <div style="margin-top:12px;padding:10px;background:rgba(71,198,255,0.1);border-radius:6px;font-size:12px;">
        <strong>Demo Credentials:</strong><br>
        Admin: admin / 1234<br>
        Teacher: teacher1 / abcd
      </div>
    </div>
  </header>

  <div class="card">
    <div class="grid">
      <div>
        <h3>Classroom Availability</h3>
        <div class="rooms-list" id="rooms"></div>
      </div>

      <aside>
        <div class="card" style="padding:12px">
          <strong>üü¢ Currently Available</strong>
          <ul id="availableList" style="margin-top:6px;font-size:14px;color:var(--ok); padding-left: 20px;"></ul>
        </div>
        
        <div class="card" style="padding:12px">
          <strong>Selected Room Details</strong>
          <div id="selectedInfo" style="margin-top:6px;font-size:14px;color:var(--muted)">Click a room to see schedule</div>
        </div>
        
        <div class="card" style="padding:12px">
          <strong>Legend</strong>
          <div style="margin-top:8px;font-size:12px;">
            <div style="display:flex;align-items:center;gap:8px;margin:4px 0;">
              <div class="status available" style="font-size:10px;padding:2px 6px;">Available</div>
              <span>Ready to book</span>
            </div>
            <div style="display:flex;align-items:center;gap:8px;margin:4px 0;">
              <div class="status occupied" style="font-size:10px;padding:2px 6px;">Occupied</div>
              <span>Currently in use</span>
            </div>
            <div style="display:flex;align-items:center;gap:8px;margin:4px 0;">
              <div class="status reserved" style="font-size:10px;padding:2px 6px;">Reserved</div>
              <span>Future bookings</span>
            </div>
          </div>
        </div>
      </aside>
    </div>
    <footer id="footerText">üîç Viewing in guest mode. Login to make reservations and manage bookings.</footer>
  </div>
</div>

<!-- Booking Modal -->
<div id="bookingModal" class="modal">
  <div class="modal-content">
    <h3>Reserve Room</h3>
    <div>
      <label style="display:block;margin-bottom:4px;font-size:14px;">Room:</label>
      <input id="modalRoom" readonly style="background:#0f172a;">
    </div>
    <div class="time-input-group">
      <div>
        <label style="display:block;margin-bottom:4px;font-size:14px;">Start Time:</label>
        <input type="time" id="startTime" required>
      </div>
      <div>
        <label style="display:block;margin-bottom:4px;font-size:14px;">End Time:</label>
        <input type="time" id="endTime" required>
      </div>
    </div>
    <div id="conflictWarning" class="warning" style="display:none;"></div>
    <div id="bookingError" class="error" style="display:none;"></div>
    <div id="bookingSuccess" class="success" style="display:none;"></div>
    
    <div style="margin:12px 0;padding:10px;background:rgba(167,139,250,0.1);border-radius:6px;font-size:12px;">
      <strong>Current Schedule:</strong>
      <div id="modalSchedule" style="margin-top:6px;"></div>
    </div>
    
    <div class="modal-buttons">
      <button id="cancelBooking" class="btn-secondary">Cancel</button>
      <button id="confirmBooking">Reserve Room</button>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <h3 id="confirmTitle">Confirm Action</h3>
    <p id="confirmMessage">Are you sure?</p>
    <div class="modal-buttons">
      <button id="cancelConfirm" class="btn-secondary">Cancel</button>
      <button id="confirmAction" class="btn-danger">Confirm</button>
    </div>
  </div>
</div>

<script>
  /* Demo Users */
  const users = [
    { username: 'admin', password: '1234' },
    { username: 'teacher1', password: 'abcd' }
  ];

  /* Demo Rooms with reservation system */
  const initialRooms = [
    { 
      id: 'PICE 201', 
      reservations: [] 
    },
    { 
      id: 'GAB 101', 
      reservations: [
        { start: '10:00', end: '11:00', user: 'teacher1', type: 'current' },
        { start: '14:00', end: '15:30', user: 'admin', type: 'reserved' }
      ]
    },
    { 
      id: 'Auditorium', 
      reservations: [
        { start: '13:00', end: '14:00', user: 'teacher1', type: 'reserved' }
      ]
    },
    { 
      id: 'Chem/Physics Lab', 
      reservations: [] 
    },
    { 
      id: 'Accreditation Room', 
      reservations: [
        { start: '09:00', end: '10:30', user: 'admin', type: 'current' }
      ]
    }
  ];

  let rooms = JSON.parse(JSON.stringify(initialRooms));
  let currentUser = null;
  let selectedRoom = null;

  // DOM Elements
  const loginForm = document.getElementById('loginForm');
  const loginToggle = document.getElementById('loginToggle');
  const logoutBtn = document.getElementById('logoutBtn');
  const userStatus = document.getElementById('userStatus');
  const loginBtn = document.getElementById('loginBtn');
  const cancelLogin = document.getElementById('cancelLogin');
  const loginMsg = document.getElementById('loginMsg');
  const roomsContainer = document.getElementById('rooms');
  const availableList = document.getElementById('availableList');
  const selectedInfo = document.getElementById('selectedInfo');
  const footerText = document.getElementById('footerText');

  // Modal Elements
  const bookingModal = document.getElementById('bookingModal');
  const confirmModal = document.getElementById('confirmModal');
  const modalRoom = document.getElementById('modalRoom');
  const startTime = document.getElementById('startTime');
  const endTime = document.getElementById('endTime');
  const modalSchedule = document.getElementById('modalSchedule');
  const conflictWarning = document.getElementById('conflictWarning');
  const bookingError = document.getElementById('bookingError');
  const bookingSuccess = document.getElementById('bookingSuccess');

  /* Utility Functions */
  function timeToMinutes(timeStr) {
    const [hours, minutes] = timeStr.split(':').map(Number);
    return hours * 60 + minutes;
  }

  function minutesToTime(minutes) {
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
  }

  function isValidTimeRange(start, end) {
    return timeToMinutes(start) < timeToMinutes(end);
  }

  function getCurrentTime() {
    const now = new Date();
    return now.toTimeString().slice(0, 5);
  }

  function getCurrentMinutes() {
    return timeToMinutes(getCurrentTime());
  }

  function hasConflict(room, startTime, endTime, excludeReservation = null) {
    const startMin = timeToMinutes(startTime);
    const endMin = timeToMinutes(endTime);
    
    return room.reservations.some(res => {
      if (excludeReservation && res === excludeReservation) return false;
      const resStartMin = timeToMinutes(res.start);
      const resEndMin = timeToMinutes(res.end);
      
      return (startMin < resEndMin && endMin > resStartMin);
    });
  }

  function getRoomStatus(room) {
    const currentMin = getCurrentMinutes();
    const currentRes = room.reservations.find(res => 
      timeToMinutes(res.start) <= currentMin && timeToMinutes(res.end) > currentMin
    );
    
    if (currentRes) return 'occupied';
    
    const hasUpcoming = room.reservations.some(res => 
      timeToMinutes(res.start) > currentMin
    );
    
    return hasUpcoming ? 'reserved' : 'available';
  }

  function getCurrentOccupant(room) {
    const currentMin = getCurrentMinutes();
    return room.reservations.find(res => 
      timeToMinutes(res.start) <= currentMin && timeToMinutes(res.end) > currentMin
    );
  }

  function updateReservationTypes() {
    const currentMin = getCurrentMinutes();
    rooms.forEach(room => {
      room.reservations.forEach(res => {
        const startMin = timeToMinutes(res.start);
        const endMin = timeToMinutes(res.end);
        
        if (startMin <= currentMin && endMin > currentMin) {
          res.type = 'current';
        } else if (endMin <= currentMin) {
          res.type = 'expired';
        } else {
          res.type = 'reserved';
        }
      });
      
      // Remove expired reservations
      room.reservations = room.reservations.filter(res => res.type !== 'expired');
    });
  }

  function showError(element, message) {
    element.textContent = message;
    element.style.display = 'block';
    setTimeout(() => {
      element.style.display = 'none';
    }, 5000);
  }

  function showSuccess(element, message) {
    element.textContent = message;
    element.style.display = 'block';
    setTimeout(() => {
      element.style.display = 'none';
    }, 3000);
  }

  /* Auth Functions */
  loginToggle.onclick = () => {
    loginForm.classList.toggle('show');
    loginMsg.textContent = '';
  };

  cancelLogin.onclick = () => {
    loginForm.classList.remove('show');
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    loginMsg.textContent = '';
  };

  logoutBtn.onclick = () => {
    currentUser = null;
    userStatus.textContent = 'Guest Mode';
    loginToggle.style.display = 'block';
    logoutBtn.style.display = 'none';
    loginForm.classList.remove('show');
    footerText.textContent = 'üîç Viewing in guest mode. Login to make reservations and manage bookings.';
    renderRooms();
  };

  loginBtn.onclick = () => {
    const u = document.getElementById('username').value.trim();
    const p = document.getElementById('password').value;
    
    if (!u || !p) {
      loginMsg.textContent = "Please enter both username and password";
      loginMsg.style.color = 'var(--bad)';
      return;
    }

    const found = users.find(x => x.username === u && x.password === p);
    if (found) {
      currentUser = u;
      userStatus.textContent = `Logged in as ${currentUser}`;
      loginToggle.style.display = 'none';
      logoutBtn.style.display = 'block';
      loginForm.classList.remove('show');
      footerText.textContent = `‚úÖ Logged in as ${currentUser}. You can now make reservations and manage your bookings.`;
      renderRooms();
    } else {
      loginMsg.textContent = "Invalid credentials";
      loginMsg.style.color = 'var(--bad)';
    }
  };

  /* Modal Functions */
  function showBookingModal(roomId) {
    const room = rooms.find(r => r.id === roomId);
    modalRoom.value = roomId;
    startTime.value = getCurrentTime();
    endTime.value = '';
    bookingError.style.display = 'none';
    bookingSuccess.style.display = 'none';
    conflictWarning.style.display = 'none';
    
    updateModalSchedule(room);
    bookingModal.classList.add('show');
  }

  function updateModalSchedule(room) {
    const schedule = generateDaySchedule(room);
    modalSchedule.innerHTML = schedule.map(slot => 
      `<div class="time-slot">
        <span class="slot-time">${slot.time}</span>
        <span class="slot-status ${slot.class}">${slot.status}</span>
       </div>`
    ).join('');
  }

  function generateDaySchedule(room) {
    const schedule = [];
    const currentMin = getCurrentMinutes();
    
    for (let hour = 8; hour < 18; hour++) {
      const timeStr = `${hour.toString().padStart(2, '0')}:00`;
      const timeMin = timeToMinutes(timeStr);
      
      let status = 'Free';
      let className = 'slot-free';
      
      const reservation = room.reservations.find(res => 
        timeToMinutes(res.start) <= timeMin && timeToMinutes(res.end) > timeMin
      );
      
      if (reservation) {
        if (timeMin < currentMin && timeToMinutes(reservation.end) > currentMin) {
          status = `In Use (${reservation.user})`;
          className = 'slot-occupied';
        } else if (timeToMinutes(reservation.start) > currentMin) {
          status = `Reserved (${reservation.user})`;
          className = 'slot-reserved';
        } else {
          status = `In Use (${reservation.user})`;
          className = 'slot-occupied';
        }
      }
      
      schedule.push({ time: timeStr, status, class: className });
    }
    
    return schedule;
  }

  function hideBookingModal() {
    bookingModal.classList.remove('show');
  }

  function showConfirmModal(title, message, callback) {
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmMessage').textContent = message;
    confirmModal.classList.add('show');
    
    document.getElementById('confirmAction').onclick = () => {
      confirmModal.classList.remove('show');
      callback();
    };
  }

  function hideConfirmModal() {
    confirmModal.classList.remove('show');
  }

  /* Render Functions */
  function renderRooms() {
    updateReservationTypes();
    
    roomsContainer.innerHTML = "";
    availableList.innerHTML = "";
    let availableCount = 0;
    
    rooms.forEach(r => {
      const status = getRoomStatus(r);
      const currentOccupant = getCurrentOccupant(r);
      
      const div = document.createElement('div');
      div.className = 'room';
      if (selectedRoom && selectedRoom.id === r.id) {
        div.classList.add('selected');
      }

      let statusText = status === 'available' ? 'Available' : 
                      status === 'occupied' ? 'Occupied' : 'Reserved';

      let content = `
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
          <div class="chip">${r.id}</div>
          <div class="status ${status}">${statusText}</div>
        </div>`;

      if (currentOccupant) {
        content += `<div style="margin-top:6px;font-size:13px; color: var(--muted);">
          Currently: ${currentOccupant.user} (${currentOccupant.start} - ${currentOccupant.end})
        </div>`;
      }

      // Show upcoming reservations
      const upcomingReservations = r.reservations
        .filter(res => res.type === 'reserved')
        .sort((a, b) => timeToMinutes(a.start) - timeToMinutes(b.start))
        .slice(0, 2);

      if (upcomingReservations.length > 0) {
        content += `<div class="reservations">
          <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">Upcoming:</div>`;
        upcomingReservations.forEach(res => {
          content += `<div class="reservation-item">
            <span>${res.start}-${res.end}</span>
            <span style="color:var(--reserved)">${res.user}</span>
          </div>`;
        });
        content += '</div>';
      }
      
      div.innerHTML = content;

      div.onclick = () => {
        selectedRoom = r;
        showRoomDetails(r);
        renderRooms();
      };

      // Add action buttons for logged-in users
      if (currentUser) {
        const btnContainer = document.createElement('div');
        btnContainer.style.marginTop = '10px';
        btnContainer.style.display = 'flex';
        btnContainer.style.gap = '8px';
        btnContainer.style.flexWrap = 'wrap';

        // Reserve button
        const reserveBtn = document.createElement('button');
        reserveBtn.textContent = "Reserve";
        reserveBtn.onclick = (event) => {
          event.stopPropagation();
          showBookingModal(r.id);
        };
        btnContainer.appendChild(reserveBtn);

        // Cancel reservation button (only for user's own reservations)
        const userReservations = r.reservations.filter(res => 
          res.user === currentUser && res.type !== 'expired'
        );
        
        if (userReservations.length > 0 || currentUser === 'admin') {
          const manageBtn = document.createElement('button');
          manageBtn.textContent = "Manage";
          manageBtn.className = 'btn-secondary btn-small';
          manageBtn.onclick = (event) => {
            event.stopPropagation();
            showManageReservations(r);
          };
          btnContainer.appendChild(manageBtn);
        }

        div.appendChild(btnContainer);
      }

      roomsContainer.appendChild(div);

      if (status === 'available') {
        availableCount++;
        const li = document.createElement('li');
        li.textContent = r.id;
        availableList.appendChild(li);
      }
    });

    if (availableCount === 0) {
      const li = document.createElement('li');
      li.textContent = 'All rooms are currently occupied or reserved';
      li.style.color = 'var(--muted)';
      availableList.appendChild(li);
    }
  }

  function showRoomDetails(room) {
    const status = getRoomStatus(room);
    const currentOccupant = getCurrentOccupant(room);
    
    let details = `<b>${room.id}</b><br>Status: `;
    
    if (status === 'available') {
      details += `<span style="color:var(--ok)">Available Now</span>`;
    } else if (status === 'occupied' && currentOccupant) {
      details += `<span style="color:var(--bad)">Occupied</span><br>
        By: ${currentOccupant.user}<br>
        Until: ${currentOccupant.end}`;
    } else {
      details += `<span style="color:var(--reserved)">Has Reservations</span>`;
    }

    if (room.reservations.length > 0) {
      details += '<br><br><strong>Today\'s Schedule:</strong>';
      details += '<div class="schedule-view">';
      const schedule = generateDaySchedule(room);
      schedule.forEach(slot => {
        if (slot.status !== 'Free') {
          details += `<div class="time-slot">
            <span class="slot-time">${slot.time}</span>
            <span class="slot-status ${slot.class}">${slot.status}</span>
          </div>`;
        }
      });
      details += '</div>';
    }

    selectedInfo.innerHTML = details;
    selectedInfo.style.color = 'var(--accent)';
  }

  function showManageReservations(room) {
    const userReservations = room.reservations.filter(res => 
      (res.user === currentUser || currentUser === 'admin') && res.type !== 'expired'
    );
    
    if (userReservations.length === 0) return;
    
    let message = `Reservations for ${room.id}:\n\n`;
    userReservations.forEach((res, index) => {
      message += `${index + 1}. ${res.start} - ${res.end} (${res.user})\n`;
    });
    message += '\nSelect a reservation to cancel:';
    
    // Simple selection for demo - in a real app, you'd use a proper modal
    const selection = prompt(message + '\nEnter number to cancel (or 0 to cancel):');
    const num = parseInt(selection);
    
    if (num > 0 && num <= userReservations.length) {
      const reservation = userReservations[num - 1];
      showConfirmModal(
        'Cancel Reservation',
        `Cancel reservation for ${room.id} from ${reservation.start} to ${reservation.end}?`,
        () => {
          room.reservations = room.reservations.filter(res => res !== reservation);
          renderRooms();
        }
      );
    }
  }

  /* Modal Event Handlers */
  document.getElementById('cancelBooking').onclick = hideBookingModal;
  document.getElementById('cancelConfirm').onclick = hideConfirmModal;

  // Time input change handlers to check for conflicts
  startTime.onchange = endTime.onchange = () => {
    if (startTime.value && endTime.value) {
      const room = rooms.find(r => r.id === modalRoom.value);
      if (hasConflict(room, startTime.value, endTime.value)) {
        conflictWarning.textContent = 'Warning: This time slot conflicts with existing reservations';
        conflictWarning.style.display = 'block';
      } else {
        conflictWarning.style.display = 'none';
      }
    }
  };

  document.getElementById('confirmBooking').onclick = () => {
    const roomId = modalRoom.value;
    const start = startTime.value;
    const end = endTime.value;

    // Validation
    if (!start || !end) {
      showError(bookingError, 'Please select both start and end times');
      return;
    }

    if (!isValidTimeRange(start, end)) {
      showError(bookingError, 'End time must be after start time');
      return;
    }

    const currentTime = getCurrentTime();
    if (timeToMinutes(start) < timeToMinutes(currentTime)) {
      showError(bookingError, 'Start time cannot be in the past');
      return;
    }

    // Check for conflicts
    const room = rooms.find(r => r.id === roomId);
    if (hasConflict(room, start, end)) {
      showError(bookingError, 'This time slot conflicts with existing reservations');
      return;
    }

    // Add the reservation
    room.reservations.push({
      start: start,
      end: end,
      user: currentUser,
      type: 'reserved'
    });

    // Sort reservations by start time
    room.reservations.sort((a, b) => timeToMinutes(a.start) - timeToMinutes(b.start));
    
    showSuccess(bookingSuccess, `Room ${roomId} reserved successfully from ${start} to ${end}!`);
    updateModalSchedule(room);
    
    setTimeout(() => {
      hideBookingModal();
      renderRooms();
    }, 1500);
  };

  /* Close modals when clicking outside */
  [bookingModal, confirmModal].forEach(modal => {
    modal.onclick = (e) => {
      if (e.target === modal) {
        modal.classList.remove('show');
      }
    };
  });

  /* Enter key handlers */
  document.getElementById('username').onkeypress = document.getElementById('password').onkeypress = (e) => {
    if (e.key === 'Enter') loginBtn.click();
  };

  /* Clock */
  function updateClock() {
    document.getElementById('clock').textContent = new Date().toLocaleTimeString('en-US', {
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: true
    });
  }
  setInterval(updateClock, 1000);
  setInterval(() => {
    updateReservationTypes();
    renderRooms();
  }, 60000); // Auto-refresh every minute
  updateClock();

  // Initialize - Start in guest mode
  renderRooms();
</script>
</body>
</html>
